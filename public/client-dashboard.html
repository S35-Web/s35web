<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S-35 | Panel de Cliente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root{
            --bg: #0b0c0f;
            --panel: #111319;
            --elev: rgba(255,255,255,0.06);
            --text: #e6e7ea;
            --muted: #a9aeb6;
            --primary: #0a84ff;
            --ok: #22c55e;
            --warn: #f59e0b;
            --danger: #ef4444;
            --card: #0f1116;
            --border: rgba(255,255,255,0.12);
        }
        [data-theme="light"]{
            --bg: #f6f7f9;
            --panel: #ffffff;
            --elev: rgba(0,0,0,0.04);
            --text: #0e1013;
            --muted: #4b5563;
            --primary: #0a84ff;
            --ok: #16a34a;
            --warn: #d97706;
            --danger: #dc2626;
            --card: #ffffff;
            --border: rgba(0,0,0,0.08);
        }
        *{ box-sizing: border-box; }
        body{ margin:0; font-family:"Helvetica Neue", Helvetica, Arial, sans-serif; font-weight:300; color:var(--text); background:var(--bg); }
        .app{ display:grid; grid-template-rows: 64px 1fr; min-height:100vh; }
        .topbar{
            display:flex; align-items:center; gap:16px; padding:0 20px; background:var(--panel); border-bottom:1px solid var(--border);
        }
        .brand{ display:flex; align-items:center; gap:12px; }
        .brand img{ height:26px; }
        .brand span{ letter-spacing:.4px; font-size:15px; color:var(--muted); }
        .actions{ margin-left:auto; display:flex; align-items:center; gap:10px; }
        .iconbtn{ height:36px; width:36px; display:grid; place-items:center; border:1px solid var(--border); background:transparent; color:var(--text); border-radius:10px; cursor:pointer; }
        .container{ display:grid; grid-template-columns: 260px 1fr; min-height:0; }
        .sidebar{ border-right:1px solid var(--border); background:var(--panel); padding:16px; }
        .nav{ display:grid; gap:6px; }
        .nav a{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none; border:1px solid transparent; }
        .nav a.active, .nav a:hover{ background:var(--elev); border-color:var(--border); }
        .content{ padding:22px; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
        .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
        .card h3{ margin:0 0 8px; font-weight:400; letter-spacing:.3px; }
        .muted{ color:var(--muted); font-size:13px; }
        .kpis{ display:grid; grid-template-columns: repeat(4,1fr); gap:16px; margin-bottom:16px; }
        .kpi{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; display:grid; gap:6px; }
        .kpi .val{ font-size:22px; font-weight:400; }
        .badge{ display:inline-grid; place-items:center; padding:2px 8px; border-radius:999px; font-size:12px; }
        .b-ok{ background:rgba(34,197,94,.12); color:#34d399; }
        .b-warn{ background:rgba(245,158,11,.12); color:#fbbf24; }
        .b-danger{ background:rgba(239,68,68,.12); color:#fca5a5; }
        table{ width:100%; border-collapse:collapse; }
        th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px; }
        .row-actions{ display:flex; gap:8px; }
        .btn{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; }
        .btn.primary{ background:var(--primary); border-color:transparent; color:#fff; }
        .btn.link{ border:none; color:var(--primary); background:transparent; }
        .toolbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; }
        .search{ flex:1; height:36px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); padding:0 12px; }
        .table-card{ overflow:auto; }
        @media(max-width: 960px){ .container{ grid-template-columns: 1fr; } .sidebar{ position:sticky; top:0; z-index:2; } .kpis{ grid-template-columns: repeat(2,1fr);} }
    </style>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <div class="brand">
                <img src="Assets/Logotipo Principal.png" alt="S-35"/>
                <span>Panel de Cliente</span>
            </div>
            <div class="actions">
                <button class="iconbtn" id="themeBtn" title="Tema"><i class="fa-solid fa-circle-half-stroke"></i></button>
                <button class="iconbtn" id="logoutBtn" title="Salir"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>
        <div class="container">
            <aside class="sidebar">
                <nav class="nav">
                    <a href="#resumen" class="active"><i class="fa-solid fa-gauge"></i> Resumen</a>
                    <a href="#pedidos"><i class="fa-solid fa-box"></i> Pedidos</a>
                    <a href="#facturas"><i class="fa-solid fa-file-invoice"></i> Facturas</a>
                    <a href="#surtido"><i class="fa-solid fa-truck"></i> Estatus de surtido</a>
                    <a href="#soporte"><i class="fa-solid fa-headset"></i> Soporte</a>
                </nav>
            </aside>
            <main class="content">
                <section id="resumen">
                    <div class="kpis">
                        <div class="kpi"><span class="muted">Pedidos en curso</span><span class="val" id="kpiOpen">—</span></div>
                        <div class="kpi"><span class="muted">Último pedido</span><span class="val" id="kpiLast">—</span></div>
                        <div class="kpi"><span class="muted">Saldo</span><span class="val" id="kpiBalance">—</span></div>
                        <div class="kpi"><span class="muted">Facturas pendientes</span><span class="val" id="kpiInvoices">—</span></div>
                    </div>

                    <div class="grid">
                        <div class="card" style="grid-column: span 7;">
                            <h3>Pedidos recientes</h3>
                            <div class="table-card">
                                <table id="tblRecent">
                                    <thead>
                                        <tr><th>Folio</th><th>Fecha</th><th>Productos</th><th>Total</th><th>Estatus</th><th></th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card" style="grid-column: span 5;">
                            <h3>Facturas</h3>
                            <div class="table-card">
                                <table id="tblInvoices">
                                    <thead>
                                        <tr><th>Factura</th><th>Fecha</th><th>Importe</th><th>Estatus</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="pedidos" style="margin-top:16px;">
                    <div class="toolbar">
                        <input class="search" placeholder="Buscar pedidos…"/>
                        <button class="btn primary"><i class="fa-solid fa-plus"></i> Nuevo pedido</button>
                    </div>
                    <div class="card table-card">
                        <table id="tblOrders">
                            <thead>
                                <tr><th>Folio</th><th>Fecha</th><th>Productos</th><th>Total</th><th>Estatus</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="facturas" style="margin-top:16px;">
                    <div class="card table-card">
                        <table id="tblAllInvoices">
                            <thead>
                                <tr><th>Factura</th><th>Fecha</th><th>Importe</th><th>Estatus</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="surtido" style="margin-top:16px;">
                    <div class="card">
                        <h3>Estatus de surtido</h3>
                        <p class="muted">Seguimiento de preparación y envío por pedido.</p>
                        <div id="fulfillment"></div>
                    </div>
                </section>

                <section id="soporte" style="margin-top:16px;">
                    <div class="card">
                        <h3>Soporte</h3>
                        <p class="muted">¿Dudas con tus pedidos o facturación? Escríbenos desde el formulario de contacto del sitio o al correo soporte@s35.com.</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let orders = [];
        let quotes = [];
        let invoices = [];

        // Tema claro/oscuro
        (function(){
            const root = document.documentElement;
            const saved = localStorage.getItem('clientTheme');
            if(saved){ root.setAttribute('data-theme', saved); }
            document.getElementById('themeBtn').addEventListener('click', ()=>{
                const now = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                root.setAttribute('data-theme', now);
                localStorage.setItem('clientTheme', now);
            });
        })();

        // Verificar autenticación
        function checkAuth() {
            const token = localStorage.getItem('clientToken');
            if (!token) {
                window.location.href = 'client-login.html';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;
                console.log('Cliente autenticado:', currentUser);
            } catch (error) {
                console.error('Token inválido:', error);
                localStorage.removeItem('clientToken');
                window.location.href = 'client-login.html';
            }
        }

        // Navegación
        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                document.querySelectorAll('main section').forEach(section => {
                    section.style.display = 'none';
                });
                document.querySelector(link.getAttribute('href')).style.display = 'block';
                
                // Cargar datos específicos de la sección
                const section = link.getAttribute('href').substring(1);
                loadSectionData(section);
            });
        });

        // Cargar datos de sección
        async function loadSectionData(section) {
            switch(section) {
                case 'resumen':
                    await loadDashboardData();
                    break;
                case 'pedidos':
                    await loadOrders();
                    break;
                case 'facturas':
                    await loadInvoices();
                    break;
                case 'surtido':
                    await loadFulfillment();
                    break;
                case 'soporte':
                    await loadSupport();
                    break;
            }
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('clientToken');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Error en la API');
            }
            
            return data;
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                const [ordersData, quotesData] = await Promise.all([
                    apiCall('/api/orders'),
                    apiCall('/api/quotes')
                ]);

                orders = ordersData.data;
                quotes = quotesData.data;

                // Filtrar solo los pedidos del cliente actual
                const clientOrders = orders.filter(order => order.clientId === currentUser.clientId);
                const clientQuotes = quotes.filter(quote => quote.clientId === currentUser.clientId);

                // Actualizar KPIs
                const openOrders = clientOrders.filter(o => ['confirmed', 'preparing', 'ready'].includes(o.status));
                const lastOrder = clientOrders[0];
                const pendingInvoices = clientOrders.filter(o => o.paymentStatus === 'pending');

                document.getElementById('kpiOpen').textContent = openOrders.length;
                document.getElementById('kpiLast').textContent = lastOrder?.folio || '—';
                document.getElementById('kpiBalance').textContent = '$0'; // Implementar cálculo de saldo
                document.getElementById('kpiInvoices').textContent = pendingInvoices.length;

                // Actualizar tabla de pedidos recientes
                const tbody = document.querySelector('#tblRecent tbody');
                tbody.innerHTML = clientOrders.slice(0, 5).map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>${order.items.map(item => item.productName).join(', ')}</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.status)}</td>
                    <td class="row-actions"><button class="btn link" onclick="viewOrder(${order.id})">Ver</button></td>
                </tr>`).join('');

                // Actualizar tabla de facturas
                const tbodyI = document.querySelector('#tblInvoices tbody');
                tbodyI.innerHTML = clientOrders.map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.paymentStatus === 'verified' ? 'Pagado' : 'Pendiente')}</td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showNotification('Error cargando datos del dashboard', 'error');
            }
        }

        // Cargar pedidos
        async function loadOrders() {
            try {
                const data = await apiCall('/api/orders');
                orders = data.data;

                // Filtrar solo los pedidos del cliente actual
                const clientOrders = orders.filter(order => order.clientId === currentUser.clientId);

                const tbody = document.querySelector('#tblOrders tbody');
                tbody.innerHTML = clientOrders.map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>${order.items.map(item => item.productName).join(', ')}</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.status)}</td>
                    <td class="row-actions"><button class="btn link" onclick="viewOrder(${order.id})">Ver</button></td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando pedidos:', error);
                showNotification('Error cargando pedidos', 'error');
            }
        }

        // Cargar facturas
        async function loadInvoices() {
            try {
                const data = await apiCall('/api/orders');
                orders = data.data;

                // Filtrar solo los pedidos del cliente actual
                const clientOrders = orders.filter(order => order.clientId === currentUser.clientId);

                const tbody = document.querySelector('#tblAllInvoices tbody');
                tbody.innerHTML = clientOrders.map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.paymentStatus === 'verified' ? 'Pagado' : 'Pendiente')}</td>
                    <td class="row-actions"><button class="btn link" onclick="downloadInvoice(${order.id})">Descargar</button></td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando facturas:', error);
                showNotification('Error cargando facturas', 'error');
            }
        }

        // Cargar estado de surtido
        async function loadFulfillment() {
            try {
                const data = await apiCall('/api/orders');
                orders = data.data;

                // Filtrar solo los pedidos del cliente actual
                const clientOrders = orders.filter(order => order.clientId === currentUser.clientId);

                const fulfillmentContainer = document.getElementById('fulfillment');
                fulfillmentContainer.innerHTML = clientOrders.map(order => {
                    const progress = getOrderProgress(order.status);
                    return `<div class="card" style="margin-top:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div><strong>${order.folio}</strong> <span class="muted">${new Date(order.createdAt).toLocaleDateString()}</span></div>
                            <div>${statusBadge(order.status)}</div>
                        </div>
                        <div class="muted" style="margin-top:6px;">${order.items.map(item => item.productName).join(', ')}</div>
                        <div style="margin-top:10px; height:8px; background:var(--elev); border-radius:999px; overflow:hidden;">
                            <div style="width:${progress}%; height:100%; background:var(--primary);"></div>
                        </div>
                        <div style="margin-top:8px; font-size:12px; color:var(--muted);">
                            ${getOrderStatusText(order.status)}
                        </div>
                    </div>`;
                }).join('');

            } catch (error) {
                console.error('Error cargando estado de surtido:', error);
                showNotification('Error cargando estado de surtido', 'error');
            }
        }

        // Cargar soporte
        async function loadSupport() {
            // Implementar funcionalidad de soporte
            console.log('Cargando soporte...');
        }

        // Funciones de utilidad
        function statusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge b-warn">Pendiente</span>',
                'confirmed': '<span class="badge b-ok">Confirmado</span>',
                'preparing': '<span class="badge b-warn">En preparación</span>',
                'ready': '<span class="badge b-ok">Listo</span>',
                'delivered': '<span class="badge b-ok">Entregado</span>',
                'pagado': '<span class="badge b-ok">Pagado</span>',
                'pendiente': '<span class="badge b-warn">Pendiente</span>'
            };
            return statusMap[status] || '<span class="badge b-danger">Desconocido</span>';
        }

        function getOrderProgress(status) {
            const progressMap = {
                'pending': 20,
                'confirmed': 40,
                'preparing': 60,
                'ready': 80,
                'delivered': 100
            };
            return progressMap[status] || 0;
        }

        function getOrderStatusText(status) {
            const statusTextMap = {
                'pending': 'Esperando confirmación',
                'confirmed': 'Pedido confirmado, preparando',
                'preparing': 'En proceso de preparación',
                'ready': 'Listo para entrega',
                'delivered': 'Entregado exitosamente'
            };
            return statusTextMap[status] || 'Estado desconocido';
        }

        function showNotification(message, type = 'info') {
            // Implementar sistema de notificaciones
            alert(message);
        }

        // Ver pedido
        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const orderDetails = `
                    <div style="text-align: left;">
                        <h3>Detalles del Pedido ${order.folio}</h3>
                        <p><strong>Fecha:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                        <p><strong>Estado:</strong> ${order.status}</p>
                        <p><strong>Total:</strong> $${order.total.toLocaleString()}</p>
                        <p><strong>Productos:</strong></p>
                        <ul>
                            ${order.items.map(item => `<li>${item.productName} - Cantidad: ${item.quantity} - $${item.total.toLocaleString()}</li>`).join('')}
                        </ul>
                        ${order.deliveryDate ? `<p><strong>Fecha de entrega:</strong> ${new Date(order.deliveryDate).toLocaleDateString()}</p>` : ''}
                    </div>
                `;
                alert(orderDetails);
            }
        }

        // Descargar factura
        function downloadInvoice(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                showNotification('Descargando factura...');
                // Implementar descarga de factura
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', ()=>{
            localStorage.removeItem('clientToken');
            window.location.href = 'client-login.html';
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadDashboardData();
        });
    </script>
</body>
</html>


