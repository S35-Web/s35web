<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S-35 | Punto de Venta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root{
            --bg: #0b0c0f;
            --panel: #111319;
            --elev: rgba(255,255,255,0.06);
            --text: #e6e7ea;
            --muted: #a9aeb6;
            --primary: #0a84ff;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --card: #0f1116;
            --border: rgba(255,255,255,0.12);
            --accent: #8b5cf6;
        }
        [data-theme="light"]{
            --bg: #f6f7f9;
            --panel: #ffffff;
            --elev: rgba(0,0,0,0.04);
            --text: #0e1013;
            --muted: #4b5563;
            --primary: #0a84ff;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --card: #ffffff;
            --border: rgba(0,0,0,0.08);
            --accent: #7c3aed;
        }
        *{ box-sizing: border-box; }
        body{ margin:0; font-family:"Helvetica Neue", Helvetica, Arial, sans-serif; font-weight:300; color:var(--text); background:var(--bg); }
        .app{ display:grid; grid-template-rows: 64px 1fr; min-height:100vh; }
        .topbar{
            display:flex; align-items:center; gap:16px; padding:0 20px; background:var(--panel); border-bottom:1px solid var(--border);
        }
        .brand{ display:flex; align-items:center; gap:12px; }
        .brand img{ height:26px; }
        .brand span{ letter-spacing:.4px; font-size:15px; color:var(--muted); }
        .actions{ margin-left:auto; display:flex; align-items:center; gap:10px; }
        .iconbtn{ height:36px; width:36px; display:grid; place-items:center; border:1px solid var(--border); background:transparent; color:var(--text); border-radius:10px; cursor:pointer; }
        .container{ display:grid; grid-template-columns: 280px 1fr; min-height:0; }
        .sidebar{ border-right:1px solid var(--border); background:var(--panel); padding:16px; }
        .nav{ display:grid; gap:6px; }
        .nav a{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none; border:1px solid transparent; }
        .nav a.active, .nav a:hover{ background:var(--elev); border-color:var(--border); }
        .content{ padding:22px; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
        .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
        .card h3{ margin:0 0 8px; font-weight:400; letter-spacing:.3px; }
        .muted{ color:var(--muted); font-size:13px; }
        .kpis{ display:grid; grid-template-columns: repeat(4,1fr); gap:16px; margin-bottom:16px; }
        .kpi{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; display:grid; gap:6px; }
        .kpi .val{ font-size:22px; font-weight:400; }
        .badge{ display:inline-grid; place-items:center; padding:2px 8px; border-radius:999px; font-size:12px; }
        .b-success{ background:rgba(34,197,94,.12); color:#34d399; }
        .b-warning{ background:rgba(245,158,11,.12); color:#fbbf24; }
        .b-danger{ background:rgba(239,68,68,.12); color:#fca5a5; }
        .b-primary{ background:rgba(10,132,255,.12); color:#60a5fa; }
        table{ width:100%; border-collapse:collapse; }
        th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px; }
        .row-actions{ display:flex; gap:8px; }
        .btn{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; }
        .btn.primary{ background:var(--primary); border-color:transparent; color:#fff; }
        .btn.success{ background:var(--success); border-color:transparent; color:#fff; }
        .btn.link{ border:none; color:var(--primary); background:transparent; }
        .toolbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; }
        .search{ flex:1; height:36px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); padding:0 12px; }
        .table-card{ overflow:auto; }
        .form-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
        .form-group{ display:grid; gap:6px; }
        .form-group label{ font-size:12px; color:var(--muted); letter-spacing:.3px; }
        .form-group input, .form-group select, .form-group textarea{ 
            padding:10px 12px; border-radius:8px; border:1px solid var(--border); 
            background:transparent; color:var(--text); font-size:14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus{ 
            outline:none; border-color:var(--primary); 
        }
        .modal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:grid; place-items:center; z-index:1000; }
        .modal-content{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; width:min(90vw,600px); max-height:90vh; overflow:auto; }
        .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .modal-title{ font-size:18px; font-weight:400; }
        .close-btn{ background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px; }
        .product-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px; }
        .product-card{ 
            background:var(--elev); 
            border:1px solid var(--border); 
            border-radius:12px; 
            padding:16px; 
            cursor:pointer; 
            transition:all .2s; 
            position:relative;
            overflow:hidden;
        }
        .product-card:hover{ 
            border-color:var(--primary); 
            transform:translateY(-2px);
            box-shadow:0 8px 24px rgba(0,0,0,0.15);
        }
        .product-card.selected{ border-color:var(--primary); background:rgba(10,132,255,.1); }
        .product-image{
            position:relative;
            width:100%;
            height:120px;
            margin-bottom:12px;
            border-radius:8px;
            overflow:hidden;
        }
        .product-image img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .product-status{
            position:absolute;
            top:8px;
            right:8px;
            padding:4px 8px;
            border-radius:12px;
            font-size:10px;
            font-weight:600;
            text-transform:uppercase;
        }
        .product-status.active{ background:var(--success); color:white; }
        .product-status.low_stock{ background:var(--warning); color:white; }
        .product-status.out_of_stock{ background:var(--danger); color:white; }
        .product-info h4{
            margin:0 0 8px 0;
            font-size:14px;
            font-weight:600;
            color:var(--text);
            line-height:1.3;
        }
        .product-category{
            font-size:11px;
            color:var(--muted);
            margin:0 0 4px 0;
            text-transform:uppercase;
            font-weight:500;
        }
        .product-sku{
            font-size:10px;
            color:var(--muted);
            margin:0 0 8px 0;
            font-family:monospace;
        }
        .product-price{
            font-size:16px;
            font-weight:700;
            color:var(--success);
            margin:0 0 8px 0;
        }
        .product-stock{
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-size:11px;
            margin:0 0 8px 0;
        }
        .product-stock span{ color:var(--muted); }
        .min-stock{ color:var(--warning) !important; font-weight:500; }
        .product-description{
            font-size:11px;
            color:var(--muted);
            margin:0;
            line-height:1.4;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
        }
        .product-name{ font-weight:400; margin-bottom:4px; }
        .product-price{ color:var(--success); font-size:14px; }
        .cart-item{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
        .cart-item:last-child{ border-bottom:none; }
        .cart-controls{ display:flex; align-items:center; gap:8px; }
        .qty-input{ width:60px; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text); text-align:center; }
        @media(max-width: 960px){ 
            .container{ grid-template-columns: 1fr; } 
            .sidebar{ position:sticky; top:0; z-index:2; } 
            .kpis{ grid-template-columns: repeat(2,1fr);} 
            .form-grid{ grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <div class="brand">
                <img src="Assets/Logotipo Principal.png" alt="S-35"/>
                <span>Punto de Venta</span>
            </div>
            <div class="actions">
                <button class="iconbtn" id="themeBtn" title="Tema"><i class="fa-solid fa-circle-half-stroke"></i></button>
                <button class="iconbtn" id="logoutBtn" title="Salir"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>
        <div class="container">
            <aside class="sidebar">
                <nav class="nav">
                    <a href="#dashboard" class="active"><i class="fa-solid fa-gauge"></i> Dashboard</a>
                    <a href="#pedidos"><i class="fa-solid fa-box"></i> Pedidos</a>
                    <a href="#cotizaciones"><i class="fa-solid fa-file-invoice"></i> Cotizaciones</a>
                    <a href="#clientes"><i class="fa-solid fa-users"></i> Clientes</a>
                    <a href="#productos"><i class="fa-solid fa-cube"></i> Productos</a>
                    <a href="#reportes"><i class="fa-solid fa-chart-line"></i> Reportes</a>
                </nav>
            </aside>
            <main class="content">
                <section id="dashboard">
                    <div class="kpis">
                        <div class="kpi"><span class="muted">Ventas Hoy</span><span class="val" id="kpiToday">$12,450</span></div>
                        <div class="kpi"><span class="muted">Pedidos Pendientes</span><span class="val" id="kpiPending">8</span></div>
                        <div class="kpi"><span class="muted">Clientes Activos</span><span class="val" id="kpiClients">24</span></div>
                        <div class="kpi"><span class="muted">Meta Mensual</span><span class="val" id="kpiTarget">78%</span></div>
                    </div>

                    <div class="grid">
                        <div class="card" style="grid-column: span 8;">
                            <h3>Pedidos Recientes</h3>
                            <div class="table-card">
                                <table id="tblRecentOrders">
                                    <thead>
                                        <tr><th>Folio</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estatus</th><th></th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card" style="grid-column: span 4;">
                            <h3>Acciones Rápidas</h3>
                            <div style="display:grid; gap:8px;">
                                <button class="btn primary" onclick="openModal('newOrder')"><i class="fa-solid fa-plus"></i> Nuevo Pedido</button>
                                <button class="btn success" onclick="openModal('newQuote')"><i class="fa-solid fa-file-invoice"></i> Nueva Cotización</button>
                                <button class="btn" onclick="openModal('newClient')"><i class="fa-solid fa-user-plus"></i> Nuevo Cliente</button>
                                <button class="btn" onclick="openModal('searchProducts')"><i class="fa-solid fa-search"></i> Buscar Productos</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="pedidos" style="display:none;">
                    <div class="toolbar">
                        <input class="search" placeholder="Buscar pedidos..."/>
                        <button class="btn primary" onclick="openModal('newOrder')"><i class="fa-solid fa-plus"></i> Nuevo Pedido</button>
                    </div>
                    <div class="card table-card">
                        <table id="tblOrders">
                            <thead>
                                <tr><th>Folio</th><th>Cliente</th><th>Fecha</th><th>Productos</th><th>Total</th><th>Estatus</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="cotizaciones" style="display:none;">
                    <div class="toolbar">
                        <input class="search" placeholder="Buscar cotizaciones..."/>
                        <button class="btn primary" onclick="openModal('newQuote')"><i class="fa-solid fa-plus"></i> Nueva Cotización</button>
                    </div>
                    <div class="card table-card">
                        <table id="tblQuotes">
                            <thead>
                                <tr><th>Folio</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Válida Hasta</th><th>Estatus</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="clientes" style="display:none;">
                    <div class="toolbar">
                        <input class="search" placeholder="Buscar clientes..."/>
                        <button class="btn primary" onclick="openModal('newClient')"><i class="fa-solid fa-plus"></i> Nuevo Cliente</button>
                    </div>
                    <div class="card table-card">
                        <table id="tblClients">
                            <thead>
                                <tr><th>Cliente</th><th>Empresa</th><th>Email</th><th>Teléfono</th><th>Último Pedido</th><th></th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <section id="productos" style="display:none;">
                    <div class="toolbar">
                        <input class="search" placeholder="Buscar productos..." id="productSearch" onkeyup="filterProducts()"/>
                        <select id="categoryFilter" onchange="filterProducts()" style="width: auto;">
                            <option value="">Todas las categorías</option>
                            <option value="Base">Base</option>
                            <option value="Acabado">Acabado</option>
                            <option value="Adhesivo">Adhesivo</option>
                            <option value="Piso">Piso</option>
                            <option value="Especializado">Especializado</option>
                            <option value="Premium">Premium</option>
                        </select>
                        <button class="btn" onclick="loadProducts()"><i class="fa-solid fa-refresh"></i> Actualizar</button>
                    </div>
                    <div class="product-grid" id="productGrid"></div>
                </section>

                <section id="reportes" style="display:none;">
                    <div class="toolbar">
                        <input type="date" id="reportStartDate" class="search" style="width: auto;">
                        <input type="date" id="reportEndDate" class="search" style="width: auto;">
                        <button class="btn primary" onclick="loadReports()"><i class="fa-solid fa-chart-line"></i> Generar Reporte</button>
                    </div>
                    
                    <div class="grid">
                        <div class="card" style="grid-column: span 8;">
                            <h3>Ventas por Período</h3>
                            <div id="salesChart" class="chart-container">
                                <i class="fa-solid fa-chart-line" style="font-size:48px; margin-bottom:16px;"></i>
                                <div>Selecciona un período para ver el gráfico</div>
                            </div>
                        </div>
                        <div class="card" style="grid-column: span 4;">
                            <h3>Top Productos</h3>
                            <div id="topProducts" style="display:grid; gap:8px;">
                                <div class="muted">Cargando productos...</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid" style="margin-top: 16px;">
                        <div class="card" style="grid-column: span 6;">
                            <h3>Análisis de Clientes</h3>
                            <div id="clientAnalysis" class="table-card">
                                <table>
                                    <thead>
                                        <tr><th>Cliente</th><th>Pedidos</th><th>Total</th><th>Categoría</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card" style="grid-column: span 6;">
                            <h3>Estado del Inventario</h3>
                            <div id="inventoryStatus">
                                <div class="muted">Cargando estado del inventario...</div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal Nuevo Pedido -->
    <div class="modal" id="newOrderModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Pedido</h3>
                <button class="close-btn" onclick="closeModal('newOrderModal')">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="orderClient">
                        <option value="">Seleccionar cliente...</option>
                        <option value="1">Constructora ABC</option>
                        <option value="2">Ingeniería XYZ</option>
                        <option value="3">Arquitectos Unidos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de Entrega</label>
                    <input type="date" id="orderDate">
                </div>
            </div>
            <div class="form-group">
                <label>Productos</label>
                <div class="product-grid" id="orderProducts"></div>
            </div>
            <div class="form-group">
                <label>Carrito</label>
                <div id="orderCart"></div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
                <button class="btn" onclick="closeModal('newOrderModal')">Cancelar</button>
                <button class="btn primary" onclick="createOrder()">Crear Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Cotización -->
    <div class="modal" id="newQuoteModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Cotización</h3>
                <button class="close-btn" onclick="closeModal('newQuoteModal')">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="quoteClient">
                        <option value="">Seleccionar cliente...</option>
                        <option value="1">Constructora ABC</option>
                        <option value="2">Ingeniería XYZ</option>
                        <option value="3">Arquitectos Unidos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Válida Hasta</label>
                    <input type="date" id="quoteValidUntil">
                </div>
            </div>
            <div class="form-group">
                <label>Productos</label>
                <div class="product-grid" id="quoteProducts"></div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
                <button class="btn" onclick="closeModal('newQuoteModal')">Cancelar</button>
                <button class="btn primary" onclick="createQuote()">Crear Cotización</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div class="modal" id="newClientModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Cliente</h3>
                <button class="close-btn" onclick="closeModal('newClientModal')">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="clientName" placeholder="Juan Pérez">
                </div>
                <div class="form-group">
                    <label>Empresa</label>
                    <input type="text" id="clientCompany" placeholder="Constructora ABC">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" placeholder="juan@empresa.com">
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="tel" id="clientPhone" placeholder="+52 667 123 4567">
                </div>
                <div class="form-group">
                    <label>Dirección</label>
                    <textarea id="clientAddress" placeholder="Calle, Colonia, Ciudad"></textarea>
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="clientNotes" placeholder="Información adicional..."></textarea>
                </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
                <button class="btn" onclick="closeModal('newClientModal')">Cancelar</button>
                <button class="btn primary" onclick="createClient()">Crear Cliente</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let products = [];
        let clients = [];
        let orders = [];
        let quotes = [];
        let currentCart = [];
        let currentQuote = null;

        // Tema claro/oscuro
        (function(){
            const root = document.documentElement;
            const saved = localStorage.getItem('posTheme');
            if(saved){ root.setAttribute('data-theme', saved); }
            document.getElementById('themeBtn').addEventListener('click', ()=>{
                const now = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                root.setAttribute('data-theme', now);
                localStorage.setItem('posTheme', now);
            });
        })();

        // Verificar autenticación
        function checkAuth() {
            const token = localStorage.getItem('posToken');
            if (!token) {
                window.location.href = 'pos-login.html';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;
                console.log('Usuario autenticado:', currentUser);
            } catch (error) {
                console.error('Token inválido:', error);
                localStorage.removeItem('posToken');
                window.location.href = 'pos-login.html';
            }
        }

        // Navegación
        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                document.querySelectorAll('main section').forEach(section => {
                    section.style.display = 'none';
                });
                document.querySelector(link.getAttribute('href')).style.display = 'block';
                
                // Cargar datos específicos de la sección
                const section = link.getAttribute('href').substring(1);
                loadSectionData(section);
            });
        });

        // Cargar datos de sección
        async function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    await loadDashboardData();
                    break;
                case 'pedidos':
                    await loadOrders();
                    break;
                case 'cotizaciones':
                    await loadQuotes();
                    break;
                case 'clientes':
                    await loadClients();
                    break;
                case 'productos':
                    await loadProducts();
                    break;
                case 'reportes':
                    await loadReports();
                    break;
            }
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('posToken');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Error en la API');
            }
            
            return data;
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                const [ordersData, quotesData, statsData] = await Promise.all([
                    apiCall('/api/orders'),
                    apiCall('/api/quotes'),
                    apiCall('/api/orders/stats')
                ]);

                orders = ordersData.data;
                quotes = quotesData.data;

                // Actualizar KPIs
                document.getElementById('kpiToday').textContent = `$${statsData.data.todayRevenue.toLocaleString()}`;
                document.getElementById('kpiPending').textContent = statsData.data.pendingOrders;
                document.getElementById('kpiClients').textContent = statsData.data.totalClients || 0;
                document.getElementById('kpiTarget').textContent = '78%';

                // Actualizar tabla de pedidos recientes
                const tbody = document.querySelector('#tblRecentOrders tbody');
                tbody.innerHTML = orders.slice(0, 5).map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${order.clientName}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.status)}</td>
                    <td class="row-actions"><button class="btn link" onclick="viewOrder(${order.id})">Ver</button></td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showNotification('Error cargando datos del dashboard', 'error');
            }
        }

        // Cargar pedidos
        async function loadOrders() {
            try {
                const data = await apiCall('/api/orders');
                orders = data.data;

                const tbody = document.querySelector('#tblOrders tbody');
                tbody.innerHTML = orders.map(order => `<tr>
                    <td>${order.folio}</td>
                    <td>${order.clientName}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>${order.items.length} productos</td>
                    <td>$${order.total.toLocaleString()}</td>
                    <td>${statusBadge(order.status)}</td>
                    <td class="row-actions">
                        <button class="btn link" onclick="viewOrder(${order.id})">Ver</button>
                        <button class="btn link" onclick="updateOrderStatus(${order.id})">Actualizar</button>
                    </td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando pedidos:', error);
                showNotification('Error cargando pedidos', 'error');
            }
        }

        // Cargar cotizaciones
        async function loadQuotes() {
            try {
                const data = await apiCall('/api/quotes');
                quotes = data.data;

                const tbody = document.querySelector('#tblQuotes tbody');
                tbody.innerHTML = quotes.map(quote => `<tr>
                    <td>${quote.folio}</td>
                    <td>${quote.clientName}</td>
                    <td>${new Date(quote.createdAt).toLocaleDateString()}</td>
                    <td>$${quote.total.toLocaleString()}</td>
                    <td>${new Date(quote.validUntil).toLocaleDateString()}</td>
                    <td>${statusBadge(quote.status)}</td>
                    <td class="row-actions">
                        <button class="btn link" onclick="viewQuote(${quote.id})">Ver</button>
                        ${quote.status === 'paid' ? `<button class="btn primary" onclick="convertToOrder(${quote.id})">Convertir a Pedido</button>` : ''}
                        ${quote.status === 'pending' ? `<button class="btn success" onclick="uploadPaymentProof(${quote.id})">Subir Comprobante</button>` : ''}
                    </td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando cotizaciones:', error);
                showNotification('Error cargando cotizaciones', 'error');
            }
        }

        // Cargar clientes
        async function loadClients() {
            try {
                const data = await apiCall('/api/clients');
                clients = data.data;

                const tbody = document.querySelector('#tblClients tbody');
                tbody.innerHTML = clients.map(client => `<tr>
                    <td>${client.contact}</td>
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>${new Date(client.createdAt).toLocaleDateString()}</td>
                    <td class="row-actions">
                        <button class="btn link" onclick="editClient(${client.id})">Editar</button>
                    </td>
                </tr>`).join('');

            } catch (error) {
                console.error('Error cargando clientes:', error);
                showNotification('Error cargando clientes', 'error');
            }
        }

        // Cargar productos
        async function loadProducts() {
            try {
                const data = await apiCall('/api/products?limit=100');
                products = data.data || [];
                updateProductGrid();
            } catch (error) {
                console.error('Error cargando productos:', error);
                showNotification('Error cargando productos', 'error');
            }
        }

        // Filtrar productos
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                                    (product.sku && product.sku.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });
            
            updateProductGrid(filteredProducts);
        }

        // Actualizar grid de productos
        function updateProductGrid(productsToShow = products) {
            const grid = document.getElementById('productGrid');
            
            if (productsToShow.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--muted);">
                        <i class="fa-solid fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <div>No se encontraron productos</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = productsToShow.map(product => `
                <div class="product-card" onclick="addToCart('${product._id}')">
                    <div class="product-image">
                        <img src="Assets/${product.image}" alt="${product.name}" onerror="this.src='Assets/card.png'"/>
                        <div class="product-status ${product.status}">
                            ${product.status === 'low_stock' ? 'Stock Bajo' : 
                              product.status === 'out_of_stock' ? 'Agotado' : 
                              product.status === 'active' ? 'Disponible' : product.status}
                        </div>
                    </div>
                    <div class="product-info">
                        <h4>${product.name}</h4>
                        <p class="product-category">${product.category}</p>
                        ${product.sku ? `<p class="product-sku">SKU: ${product.sku}</p>` : ''}
                        <p class="product-price">$${product.price.toLocaleString()}</p>
                        <div class="product-stock">
                            <span>Stock: ${product.stock}</span>
                            <span class="min-stock">Mín: ${product.minStock}</span>
                        </div>
                        ${product.description ? `<p class="product-description">${product.description}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Cargar reportes
        async function loadReports() {
            try {
                const startDate = document.getElementById('reportStartDate').value || new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().split('T')[0];
                const endDate = document.getElementById('reportEndDate').value || new Date().toISOString().split('T')[0];

                const [dashboardData, topProductsData, clientData, inventoryData] = await Promise.all([
                    apiCall(`/api/sales-reports/dashboard?startDate=${startDate}&endDate=${endDate}`),
                    apiCall(`/api/sales-reports/top-products?startDate=${startDate}&endDate=${endDate}&limit=5`),
                    apiCall(`/api/sales-reports/clients?startDate=${startDate}&endDate=${endDate}`),
                    apiCall(`/api/sales-reports/inventory?startDate=${startDate}&endDate=${endDate}`)
                ]);

                // Actualizar gráfico de ventas
                updateSalesChart(dashboardData.data.sales || []);
                
                // Actualizar top productos
                updateTopProducts(topProductsData.data.topProducts || []);
                
                // Actualizar análisis de clientes
                updateClientAnalysis(clientData.data.clients || []);
                
                // Actualizar estado del inventario
                updateInventoryStatus(inventoryData.data);

            } catch (error) {
                console.error('Error cargando reportes:', error);
                showNotification('Error cargando reportes', 'error');
            }
        }

        // Actualizar gráfico de ventas
        function updateSalesChart(salesData) {
            const chartContainer = document.getElementById('salesChart');
            
            if (salesData.length === 0) {
                chartContainer.innerHTML = `
                    <i class="fa-solid fa-chart-line" style="font-size:48px; margin-bottom:16px;"></i>
                    <div>No hay datos de ventas para el período seleccionado</div>
                `;
                return;
            }

            const maxValue = Math.max(...salesData.map(item => item.totalSales));
            const chartHeight = 200;
            
            chartContainer.innerHTML = `
                <div style="display: flex; align-items: end; height: ${chartHeight}px; gap: 4px; padding: 16px;">
                    ${salesData.map(item => {
                        const height = (item.totalSales / maxValue) * (chartHeight - 40);
                        const date = new Date(item._id.year, (item._id.month || 1) - 1, item._id.day || 1);
                        return `
                            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                <div style="background: var(--primary); height: ${height}px; width: 100%; border-radius: 4px 4px 0 0; margin-bottom: 8px;"></div>
                                <div style="font-size: 10px; color: var(--muted); text-align: center;">
                                    ${date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
                                </div>
                                <div style="font-size: 9px; color: var(--success); font-weight: bold;">
                                    $${item.totalSales.toLocaleString()}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Actualizar top productos
        function updateTopProducts(products) {
            const container = document.getElementById('topProducts');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="muted">No hay datos de productos</div>';
                return;
            }

            container.innerHTML = products.map((product, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--elev); border-radius: 8px;">
                    <div>
                        <div style="font-weight: 500;">${index + 1}. ${product.productName}</div>
                        <div style="font-size: 12px; color: var(--muted);">${product.totalQuantity} unidades</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: var(--success);">$${product.totalRevenue.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // Actualizar análisis de clientes
        function updateClientAnalysis(clients) {
            const tbody = document.querySelector('#clientAnalysis tbody');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="muted">No hay datos de clientes</td></tr>';
                return;
            }

            tbody.innerHTML = clients.slice(0, 10).map(client => `
                <tr>
                    <td>${client.clientName}</td>
                    <td>${client.totalOrders}</td>
                    <td>$${client.totalSpent.toLocaleString()}</td>
                    <td>
                        <span class="badge ${client.category === 'Oro' ? 'b-success' : client.category === 'Plata' ? 'b-warning' : 'b-primary'}">
                            ${client.category}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Actualizar estado del inventario
        function updateInventoryStatus(data) {
            const container = document.getElementById('inventoryStatus');
            
            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Productos con stock bajo:</span>
                        <span class="badge b-warning">${data.summary.lowStockCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Productos agotados:</span>
                        <span class="badge b-danger">${data.summary.outOfStockCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Valor total inventario:</span>
                        <span class="badge b-success">$${data.summary.totalValue.toLocaleString()}</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Productos más vendidos vs Stock:</div>
                        ${data.stockAnalysis.slice(0, 3).map(product => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border);">
                                <span style="font-size: 12px;">${product.productName}</span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 11px; color: var(--muted);">Stock: ${product.currentStock}</span>
                                    <span class="badge ${product.status === 'low_stock' ? 'b-warning' : product.status === 'out_of_stock' ? 'b-danger' : 'b-success'}">
                                        ${product.status}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Funciones de utilidad
        function statusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge b-warning">Pendiente</span>',
                'confirmed': '<span class="badge b-primary">Confirmado</span>',
                'preparing': '<span class="badge b-warning">En preparación</span>',
                'ready': '<span class="badge b-success">Listo</span>',
                'delivered': '<span class="badge b-success">Entregado</span>',
                'paid': '<span class="badge b-success">Pagado</span>',
                'converted': '<span class="badge b-primary">Convertido</span>'
            };
            return statusMap[status] || '<span class="badge b-danger">Desconocido</span>';
        }

        function showNotification(message, type = 'info') {
            // Implementar sistema de notificaciones
            alert(message);
        }

        // Funciones de modales
        function openModal(modalId) {
            document.getElementById(modalId + 'Modal').style.display = 'grid';
            
            // Cargar datos específicos del modal
            if (modalId === 'newOrder' || modalId === 'newQuote') {
                loadClientsForSelect();
                loadProductsForSelect();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Cargar clientes para select
        async function loadClientsForSelect() {
            try {
                const data = await apiCall('/api/clients');
                const select = document.getElementById('orderClient') || document.getElementById('quoteClient');
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                        data.data.map(client => `<option value="${client.id}">${client.name} - ${client.contact}</option>`).join('');
                }
            } catch (error) {
                console.error('Error cargando clientes:', error);
            }
        }

        // Cargar productos para select
        async function loadProductsForSelect() {
            try {
                const data = await apiCall('/api/products');
                const container = document.getElementById('orderProducts') || document.getElementById('quoteProducts');
                if (container) {
                    container.innerHTML = data.data.map(product => `<div class="product-card" data-id="${product.id}" onclick="addToCart(${product.id})">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">$${product.price.toLocaleString()}</div>
                        <div class="muted">${product.category} - Stock: ${product.stock}</div>
                    </div>`).join('');
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }

        // Funciones de negocio
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = currentCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentCart.push({
                    productId: product.id,
                    productName: product.name,
                    price: product.price,
                    quantity: 1,
                    total: product.price
                });
            }

            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('orderCart');
            if (!cartContainer) return;

            cartContainer.innerHTML = currentCart.map(item => `
                <div class="cart-item">
                    <div>
                        <div>${item.productName}</div>
                        <div class="muted">$${item.price.toLocaleString()} c/u</div>
                    </div>
                    <div class="cart-controls">
                        <button onclick="updateQuantity(${item.productId}, -1)">-</button>
                        <input type="number" class="qty-input" value="${item.quantity}" min="1" onchange="setQuantity(${item.productId}, this.value)">
                        <button onclick="updateQuantity(${item.productId}, 1)">+</button>
                        <button onclick="removeFromCart(${item.productId})">×</button>
                    </div>
                    <div>$${(item.price * item.quantity).toLocaleString()}</div>
                </div>
            `).join('');

            const total = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartContainer.innerHTML += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-weight: bold;">
                Total: $${total.toLocaleString()}
            </div>`;
        }

        function updateQuantity(productId, change) {
            const item = currentCart.find(item => item.productId === productId);
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                item.total = item.price * item.quantity;
                updateCartDisplay();
            }
        }

        function setQuantity(productId, quantity) {
            const item = currentCart.find(item => item.productId === productId);
            if (item) {
                item.quantity = Math.max(1, parseInt(quantity));
                item.total = item.price * item.quantity;
                updateCartDisplay();
            }
        }

        function removeFromCart(productId) {
            currentCart = currentCart.filter(item => item.productId !== productId);
            updateCartDisplay();
        }

        // Crear pedido
        async function createOrder() {
            try {
                const clientId = document.getElementById('orderClient').value;
                const deliveryDate = document.getElementById('orderDate').value;

                if (!clientId || currentCart.length === 0) {
                    showNotification('Selecciona un cliente y agrega productos', 'error');
                    return;
                }

                const orderData = {
                    clientId: parseInt(clientId),
                    items: currentCart,
                    deliveryDate,
                    notes: ''
                };

                const response = await apiCall('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                showNotification('Pedido creado exitosamente');
                closeModal('newOrderModal');
                currentCart = [];
                loadOrders();

            } catch (error) {
                console.error('Error creando pedido:', error);
                showNotification('Error creando pedido: ' + error.message, 'error');
            }
        }

        // Crear cotización
        async function createQuote() {
            try {
                const clientId = document.getElementById('quoteClient').value;
                const validUntil = document.getElementById('quoteValidUntil').value;

                if (!clientId || currentCart.length === 0) {
                    showNotification('Selecciona un cliente y agrega productos', 'error');
                    return;
                }

                const quoteData = {
                    clientId: parseInt(clientId),
                    items: currentCart,
                    validUntil,
                    notes: ''
                };

                const response = await apiCall('/api/quotes', {
                    method: 'POST',
                    body: JSON.stringify(quoteData)
                });

                showNotification('Cotización creada exitosamente');
                closeModal('newQuoteModal');
                currentCart = [];
                loadQuotes();

            } catch (error) {
                console.error('Error creando cotización:', error);
                showNotification('Error creando cotización: ' + error.message, 'error');
            }
        }

        // Crear cliente
        async function createClient() {
            try {
                const clientData = {
                    name: document.getElementById('clientName').value,
                    contact: document.getElementById('clientCompany').value,
                    email: document.getElementById('clientEmail').value,
                    phone: document.getElementById('clientPhone').value,
                    address: document.getElementById('clientAddress').value,
                    notes: document.getElementById('clientNotes').value
                };

                const response = await apiCall('/api/clients', {
                    method: 'POST',
                    body: JSON.stringify(clientData)
                });

                showNotification('Cliente creado exitosamente');
                closeModal('newClientModal');
                loadClients();

            } catch (error) {
                console.error('Error creando cliente:', error);
                showNotification('Error creando cliente: ' + error.message, 'error');
            }
        }

        // Subir comprobante de pago
        function uploadPaymentProof(quoteId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.jpg,.jpeg,.png';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // En una implementación real, subirías el archivo a un servidor
                // Por ahora simulamos la subida
                try {
                    const response = await apiCall(`/api/quotes/${quoteId}/payment-proof`, {
                        method: 'POST',
                        body: JSON.stringify({
                            paymentProof: `comprobante_${quoteId}_${Date.now()}.${file.name.split('.').pop()}`
                        })
                    });

                    showNotification('Comprobante subido exitosamente');
                    loadQuotes();

                } catch (error) {
                    console.error('Error subiendo comprobante:', error);
                    showNotification('Error subiendo comprobante: ' + error.message, 'error');
                }
            };
            input.click();
        }

        // Convertir cotización a pedido
        async function convertToOrder(quoteId) {
            try {
                const response = await apiCall(`/api/quotes/${quoteId}`, {
                    method: 'POST'
                });

                showNotification('Cotización convertida a pedido exitosamente');
                loadQuotes();
                loadOrders();

            } catch (error) {
                console.error('Error convirtiendo cotización:', error);
                showNotification('Error convirtiendo cotización: ' + error.message, 'error');
            }
        }

        // Ver pedido
        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                alert(`Pedido: ${order.folio}\nCliente: ${order.clientName}\nTotal: $${order.total.toLocaleString()}\nEstado: ${order.status}`);
            }
        }

        // Ver cotización
        function viewQuote(quoteId) {
            const quote = quotes.find(q => q.id === quoteId);
            if (quote) {
                alert(`Cotización: ${quote.folio}\nCliente: ${quote.clientName}\nTotal: $${quote.total.toLocaleString()}\nEstado: ${quote.status}`);
            }
        }

        // Actualizar estado de pedido
        function updateOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const newStatus = prompt('Nuevo estado:', order.status);
                if (newStatus && newStatus !== order.status) {
                    // Implementar actualización de estado
                    showNotification('Estado actualizado');
                }
            }
        }

        // Editar cliente
        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                alert(`Editar cliente: ${client.name}\nContacto: ${client.contact}\nEmail: ${client.email}`);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', ()=>{
            localStorage.removeItem('posToken');
            window.location.href = 'pos-login.html';
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadDashboardData();
        });
    </script>
</body>
</html>
